import requests
from datetime import datetime, timedelta
from google.oauth2.credentials import Credentials
from google.oauth2 import service_account
from googleapiclient.discovery import build
from google.auth.transport.requests import Request
from google_auth_oauthlib.flow import Flow
import os
import urllib.parse

# ... (keep all your existing constants and imports)

def generate_google_maps_link(itinerary):
    base_url = "https://www.google.com/maps/dir/"
    waypoints = [f"{park['name']}, {park['state']}" for park in itinerary]
    encoded_waypoints = [urllib.parse.quote(wp) for wp in waypoints]
    return base_url + "/".join(encoded_waypoints)

def write_to_google_sheet(itinerary):
    service = get_sheets_service()
    if service is None:
        print("Failed to obtain Google Sheets service. Check your credentials and permissions.")
        return

    sheet = service.spreadsheets()
    
    spreadsheet_id = '1YQxfUelJPoym1ZkpszXa9B7oMddkhCQ-eCv0V10iuS8'
    range_name = 'Sheet1!A1'  # Adjust as needed
    
    values = [
        ['Order', 'Park Name', 'State', 'Visit Date', 'Forecast High', 'Forecast Low', 'Weather', 'Wind Speed', 'NPS Link', 'Directions']
    ] + [
        [park['order'], park['name'], park['state'], park['visit_date'], 
         park['forecast_high'], park['forecast_low'], park['weather'], 
         park['wind_speed'], park['nps_link'], park['directions']]
        for park in itinerary
    ]
    
    # Generate and add Google Maps link
    google_maps_link = generate_google_maps_link(itinerary)
    values.append(['', '', '', '', '', '', '', '', 'Road Trip Map', google_maps_link])
    
    body = {'values': values}
    result = sheet.values().update(
        spreadsheetId=spreadsheet_id, range=range_name,
        valueInputOption='USER_ENTERED', body=body).execute()
    
    print(f"{result.get('updatedCells')} cells updated.")

# ... (keep all your other functions unchanged)

def main():
    # 1. Select parks
    parks = get_parks("state", "CA")
    
    # 2. Retrieve weather for each park
    for park in parks:
        lat, lon = park['latitude'], park['longitude']
        visit_date = (datetime.now() + timedelta(days=parks.index(park))).strftime('%Y-%m-%d')
        park['weather'] = get_weather(lat, lon, visit_date)
    
    # 3. Sort parks
    sorted_parks = sort_parks(parks, "sunniest")
    
    # 4. Generate itinerary
    itinerary = generate_itinerary(sorted_parks)
    
    # 5. Write to Google Sheet (now includes Google Maps link)
    write_to_google_sheet(itinerary)

if __name__ == "__main__":
    main()
